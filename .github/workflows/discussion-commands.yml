name: Discussion Commands

on:
  discussion_comment:
    types: [created]

permissions:
  contents: write
  discussions: write
  pull-requests: write

jobs:
  process-command:
    runs-on: ubuntu-latest
    # Only run for comments starting with /
    if: startsWith(github.event.comment.body, '/')

    steps:
      - name: Check permissions
        id: check-perms
        uses: actions/github-script@v7
        with:
          script: |
            const authorAssociation = context.payload.comment.author_association;
            const allowed = ['OWNER', 'MEMBER', 'COLLABORATOR'];

            if (!allowed.includes(authorAssociation)) {
              // Post a comment explaining the permission issue
              await github.graphql(`
                mutation($discussionId: ID!, $body: String!) {
                  addDiscussionComment(input: {discussionId: $discussionId, body: $body}) {
                    comment { id }
                  }
                }
              `, {
                discussionId: context.payload.discussion.node_id,
                body: `> ${context.payload.comment.body}\n\n⚠️ Sorry @${context.payload.comment.user.login}, only maintainers can run slash commands.`
              });

              core.setFailed(`User ${context.payload.comment.user.login} (${authorAssociation}) does not have permission to run commands`);
              return;
            }

            core.setOutput('authorized', 'true');
            console.log(`User ${context.payload.comment.user.login} (${authorAssociation}) authorized`);

      - name: Checkout
        if: steps.check-perms.outputs.authorized == 'true'
        uses: actions/checkout@v4

      - name: Setup Node.js
        if: steps.check-perms.outputs.authorized == 'true'
        uses: actions/setup-node@v4
        with:
          node-version: "22"

      - name: Setup pnpm
        if: steps.check-perms.outputs.authorized == 'true'
        uses: pnpm/action-setup@v4

      - name: Install dependencies
        if: steps.check-perms.outputs.authorized == 'true'
        run: pnpm install --frozen-lockfile

      - name: Process command
        if: steps.check-perms.outputs.authorized == 'true'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          CRAWLER_API_URL: ${{ secrets.CRAWLER_API_URL }}
          CRAWLER_API_KEY: ${{ secrets.CRAWLER_API_KEY }}
        run: pnpm tsx scripts/process-command.ts
