name: Discussion Commands

on:
  discussion_comment:
    types: [created]

# Note: These permissions are required for the workflow to function properly:
# - contents: write - needed to create branches and commits
# - discussions: write - needed to post comments and close discussions
# - pull-requests: write - needed to create pull requests
# Rate limiting is enforced by the permission check step which restricts
# command execution to OWNER, MEMBER, and COLLABORATOR roles only.
permissions:
  contents: write
  discussions: write
  pull-requests: write

jobs:
  process-command:
    runs-on: ubuntu-latest
    # Only run for comments starting with /
    if: startsWith(github.event.comment.body, '/')

    steps:
      - name: Check permissions
        id: check-perms
        uses: actions/github-script@v7
        with:
          script: |
            const authorAssociation = context.payload.comment.author_association;
            const allowed = ['OWNER', 'MEMBER', 'COLLABORATOR'];

            if (!allowed.includes(authorAssociation)) {
              // Post a comment explaining the permission issue
              try {
                await github.graphql(`
                  mutation($discussionId: ID!, $body: String!) {
                    addDiscussionComment(input: {discussionId: $discussionId, body: $body}) {
                      comment { id }
                    }
                  }
                `, {
                  discussionId: context.payload.discussion.node_id,
                  body: `> ${context.payload.comment.body}\n\n⚠️ Sorry @${context.payload.comment.user.login}, only maintainers can run slash commands.`
                });
              } catch (error) {
                core.error(`Failed to post permission warning comment for @${context.payload.comment.user.login}: ${error}`);
                core.setFailed(`Could not notify user ${context.payload.comment.user.login} (${authorAssociation}) about insufficient permissions`);
                return;
              }

              core.setFailed(`User ${context.payload.comment.user.login} (${authorAssociation}) does not have permission to run commands`);
              return;
            }

            core.setOutput('authorized', 'true');
            console.log(`User ${context.payload.comment.user.login} (${authorAssociation}) authorized`);

      - name: Checkout
        if: steps.check-perms.outputs.authorized == 'true'
        uses: actions/checkout@v4

      - name: Setup Node.js
        if: steps.check-perms.outputs.authorized == 'true'
        uses: actions/setup-node@v4
        with:
          node-version: "22"

      - name: Setup pnpm
        if: steps.check-perms.outputs.authorized == 'true'
        uses: pnpm/action-setup@v4

      - name: Install dependencies
        if: steps.check-perms.outputs.authorized == 'true'
        run: pnpm install --frozen-lockfile

      - name: Process command
        if: steps.check-perms.outputs.authorized == 'true'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          CRAWLER_API_URL: ${{ secrets.CRAWLER_API_URL }}
          CRAWLER_API_KEY: ${{ secrets.CRAWLER_API_KEY }}
        run: pnpm tsx scripts/process-command.ts
